<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Cathedral of Praise</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f5f5f5; }
    .sidebar { background: #0b2c5d; color: white; height: 100vh; position: fixed; left: 0; top: 0; width: 250px; padding: 20px; overflow-y: auto; }
    .sidebar h4 { margin-bottom: 30px; }
    .sidebar a { color: white; text-decoration: none; display: block; padding: 10px; border-radius: 5px; margin: 5px 0; }
    .sidebar a:hover { background: rgba(255,255,255,0.1); }
    .sidebar a.active { background: #f2c94c; color: #0b2c5d; }
    .main { margin-left: 250px; padding: 20px; }
    .card { box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .stat-card { text-align: center; padding: 20px; }
    .stat-number { font-size: 2em; font-weight: bold; color: #0b2c5d; }
  </style>
</head>
<body>

<div class="sidebar">
  <h4>üîê Admin Panel</h4>
  <a href="#dashboard" class="nav-link active" onclick="switchTab('dashboard')">üìä Dashboard</a>
  <a href="#payments" class="nav-link" onclick="switchTab('payments')">üí∞ Payments</a>
  <a href="#contacts" class="nav-link" onclick="switchTab('contacts')">üí¨ Messages</a>
  <a href="#media" class="nav-link" onclick="switchTab('media')">üì∏ Media</a>
  <a href="#users" class="nav-link" onclick="switchTab('users')">üë• Users</a>
  <hr>
  <button class="btn btn-danger btn-sm w-100" onclick="logout()">Logout</button>
</div>

<div class="main">
  <!-- Dashboard Tab -->
  <div id="dashboard" class="tab-content">
    <h1>Dashboard</h1>
    <div class="row">
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="stat-number" id="totalPayments">0</div>
          <p>Total Payments</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="stat-number" id="totalAmount">0</div>
          <p>Total Amount (KES)</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="stat-number" id="totalTithes">0</div>
          <p>Tithes</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card">
          <div class="stat-number" id="totalOfferings">0</div>
          <p>Offerings</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Payments Tab -->
  <div id="payments" class="tab-content" style="display:none;">
    <h1>Payment Records</h1>
    <table class="table table-striped" id="paymentsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Payer</th>
          <th>Amount</th>
          <th>Type</th>
          <th>Method</th>
          <th>Status</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Contacts Tab -->
  <div id="contacts" class="tab-content" style="display:none;">
    <h1>Contact Messages</h1>
    <table class="table table-striped" id="contactsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Message</th>
          <th>Status</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Media Tab -->
  <div id="media" class="tab-content" style="display:none;">
    <h1>Media Uploads (Pending Approval)</h1>
    <div class="row" id="mediaContainer"></div>
  </div>

  <!-- Users Tab -->
  <div id="users" class="tab-content" style="display:none;">
    <h1>Users</h1>
    <table class="table table-striped" id="usersTable">
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = 'http://localhost:5000/api';
  
  // Check login
  document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    } else {
      loadDashboard();
    }
  });

  function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.style.display = 'none';
    });
    
    // Show selected tab
    document.getElementById(tabName).style.display = 'block';
    
    // Update nav
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
    });
    event.target.classList.add('active');

    // Load data
    if (tabName === 'payments') loadPayments();
    if (tabName === 'contacts') loadContacts();
    if (tabName === 'media') loadMedia();
  }

  async function loadDashboard() {
    const token = localStorage.getItem('token');
    
    try {
      const response = await fetch(`${API_URL}/payments/stats/summary`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      const stats = await response.json();
      document.getElementById('totalPayments').textContent = stats.total_payments;
      document.getElementById('totalAmount').textContent = (stats.total_amount || 0).toLocaleString();
      document.getElementById('totalTithes').textContent = stats.tithe_count;
      document.getElementById('totalOfferings').textContent = stats.offering_count;
    } catch (error) {
      console.error('Failed to load dashboard:', error);
    }
  }

  async function loadPayments() {
    const token = localStorage.getItem('token');
    
    try {
      const response = await fetch(`${API_URL}/payments`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      const data = await response.json();
      const tbody = document.querySelector('#paymentsTable tbody');
      tbody.innerHTML = '';

      data.payments.forEach(payment => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${payment.id}</td>
          <td>${payment.user_name}</td>
          <td>${payment.amount} ${payment.currency}</td>
          <td>${payment.payment_type}</td>
          <td>${payment.payment_method}</td>
          <td><span class="badge bg-${payment.status === 'completed' ? 'success' : 'warning'}">${payment.status}</span></td>
          <td>${new Date(payment.created_at).toLocaleDateString()}</td>
        `;
      });
    } catch (error) {
      console.error('Failed to load payments:', error);
    }
  }

  async function loadContacts() {
    const token = localStorage.getItem('token');
    
    try {
      const response = await fetch(`${API_URL}/contacts`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      const data = await response.json();
      const tbody = document.querySelector('#contactsTable tbody');
      tbody.innerHTML = '';

      data.contacts.forEach(contact => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${contact.id}</td>
          <td>${contact.name}</td>
          <td>${contact.email}</td>
          <td>${contact.message.substring(0, 50)}...</td>
          <td>${contact.status}</td>
          <td>${new Date(contact.created_at).toLocaleDateString()}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="viewContact(${contact.id})">View</button>
          </td>
        `;
      });
    } catch (error) {
      console.error('Failed to load contacts:', error);
    }
  }

  async function loadMedia() {
    const token = localStorage.getItem('token');
    
    try {
      const response = await fetch(`${API_URL}/media`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      const data = await response.json();
      const container = document.getElementById('mediaContainer');
      container.innerHTML = '';

      data.media.forEach(media => {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-3';
        col.innerHTML = `
          <div class="card">
            <img src="/uploads/media/${media.file_name}" class="card-img-top" style="height:200px;object-fit:cover;">
            <div class="card-body">
              <h5>${media.original_file_name}</h5>
              <p class="text-muted small">${media.file_type}</p>
              <div class="btn-group w-100">
                <button class="btn btn-sm btn-success" onclick="approveMedia(${media.id})">‚úì Approve</button>
                <button class="btn btn-sm btn-danger" onclick="approveMedia(${media.id}, false)">‚úó Reject</button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(col);
      });
    } catch (error) {
      console.error('Failed to load media:', error);
    }
  }

  async function approveMedia(mediaId, approve = true) {
    const token = localStorage.getItem('token');
    
    try {
      const response = await fetch(`${API_URL}/media/${mediaId}/approve`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ approved: approve })
      });

      if (response.ok) {
        alert(approve ? 'Media approved!' : 'Media rejected!');
        loadMedia();
      }
    } catch (error) {
      console.error('Failed to approve media:', error);
    }
  }

  function viewContact(contactId) {
    alert('View contact details - coming soon!');
  }

  function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = 'login.html';
  }
</script>

</body>
</html>
